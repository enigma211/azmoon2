# راهنمای سیستم ورود و ثبت‌نام با OTP

## معرفی

سیستم ورود و ثبت‌نام با کد یکبار مصرف (OTP) برای صفحه پروفایل کاربران پیاده‌سازی شده است.

## فلوی کاربری

### 1. کاربر مهمان (Guest)

وقتی کاربر لاگین نیست و به صفحه پروفایل (`/profile`) می‌رود:

1. **ورود شماره موبایل**
   - کاربر شماره موبایل خود را با فرمت `09xxxxxxxxx` وارد می‌کند
   - مثال: `09361694020`
   - دکمه "ارسال کد تایید" را می‌زند

2. **ارسال OTP**
   - سیستم چک می‌کند آیا این شماره قبلاً ثبت شده است یا نه
   - یک کد 6 رقمی تصادفی تولید می‌شود
   - کد از طریق SMS به شماره موبایل کاربر ارسال می‌شود
   - کد در session ذخیره می‌شود (اعتبار: 5 دقیقه)

3. **تایید OTP**
   - کاربر کد 6 رقمی دریافتی را وارد می‌کند
   - اگر کد صحیح باشد:
     - **کاربر قدیمی**: مستقیماً لاگین می‌شود
     - **کاربر جدید**: به مرحله ثبت‌نام هدایت می‌شود

4. **تکمیل ثبت‌نام (فقط کاربران جدید)**
   - کاربر نام و نام خانوادگی خود را وارد می‌کند
   - مثال: نام: "رضا"، نام خانوادگی: "عطریانفر"
   - حساب کاربری ایجاد می‌شود
   - پلن رایگان به کاربر اختصاص داده می‌شود
   - کاربر لاگین می‌شود

### 2. کاربر لاگین شده

وقتی کاربر لاگین است و به صفحه پروفایل می‌رود:

- پیام خوش‌آمدگویی نمایش داده می‌شود: **"خوش آمدید، [نام کاربر]! 👋"**
- اطلاعات اشتراک و پروفایل کاربر نمایش داده می‌شود
- دکمه خروج در دسترس است

## فایل‌های مرتبط

### کامپوننت‌های Livewire

1. **`app/Livewire/Auth/OtpLogin.php`**
   - مدیریت فرآیند ورود با OTP
   - مراحل: mobile → otp → register (در صورت نیاز)

2. **`app/Livewire/ProfilePage.php`**
   - صفحه پروفایل اصلی
   - نمایش فرم ورود برای مهمان‌ها
   - نمایش اطلاعات برای کاربران لاگین شده

### View ها

1. **`resources/views/livewire/auth/otp-login.blade.php`**
   - فرم ورود با OTP
   - سه مرحله: ورود موبایل، تایید کد، ثبت‌نام

2. **`resources/views/livewire/profile-page.blade.php`**
   - صفحه پروفایل
   - نمایش شرطی بر اساس وضعیت لاگین کاربر

### سرویس‌ها

1. **`app/Services/SmsService.php`**
   - ارسال SMS از طریق ملی پیامک
   - متد `sendOtp()` برای ارسال کد تایید

## تنظیمات

### فایل `.env`

```env
# تنظیمات ملی پیامک
MELIPAYAMAK_USERNAME=your_username
MELIPAYAMAK_PASSWORD=your_password
MELIPAYAMAK_FROM=09361694020

# تنظیمات OTP
OTP_ENABLED=true
MELIPAYAMAK_OTP_TEMPLATE="کد ورود شما: {code}"
```

### فایل `config/melipayamak.php`

تمام تنظیمات از فایل `.env` خوانده می‌شود.

## ویژگی‌های امنیتی

1. **محدودیت زمانی**: کد OTP بعد از 5 دقیقه منقضی می‌شود
2. **Session محافظت شده**: اطلاعات OTP در session ذخیره می‌شود
3. **Validation**: تمام ورودی‌ها اعتبارسنجی می‌شوند
4. **Rate Limiting**: می‌توان محدودیت تعداد درخواست اضافه کرد

## نکات مهم

1. شماره موبایل باید با فرمت `09xxxxxxxxx` باشد (11 رقم با صفر اول)
2. کد OTP 6 رقمی است
3. کاربران جدید به صورت خودکار پلن رایگان دریافت می‌کنند
4. نام کاربر از ترکیب نام و نام خانوادگی ساخته می‌شود

## مثال‌های استفاده

### کاربر جدید
1. شماره: `09361694020`
2. کد OTP: `123456`
3. نام: `رضا`
4. نام خانوادگی: `عطریانفر`
5. نتیجه: "خوش آمدید، رضا عطریانفر! 👋"

### کاربر قدیمی
1. شماره: `09361694020`
2. کد OTP: `123456`
3. نتیجه: "خوش آمدید، رضا عطریانفر! 👋"

## توسعه‌های آینده

- [ ] افزودن countdown timer برای ارسال مجدد کد
- [ ] افزودن rate limiting برای جلوگیری از spam
- [ ] ذخیره OTP در cache به جای session
- [ ] افزودن لاگ برای تمام تلاش‌های ورود
- [ ] افزودن امکان ویرایش پروفایل
